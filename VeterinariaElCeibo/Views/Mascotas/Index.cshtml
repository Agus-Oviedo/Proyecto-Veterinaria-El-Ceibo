@model VeterinariaElCeibo.ViewModels.MascotasIndexViewModel

@{
    ViewData["Title"] = "Mascotas";
    var cliente = Model.Cliente;

    // flags de roles
    bool esAdmin = User.IsInRole("Administrador");
    bool esVet = User.IsInRole("Veterinario");
    bool esPelu = User.IsInRole("Peluqueria");
}

<div class="mascotas-header-wrapper mb-4">
    <div class="mascotas-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-0">Mascotas</h2>

            @if (cliente != null)
            {
                <p class="text-muted mb-0 mascotas-tutor">
                    Tutor: <strong>@cliente.Nombre @cliente.Apellido</strong>
                </p>
            }
        </div>

        @if (cliente != null)
        {
            <a asp-action="Create"
               asp-route-clienteId="@cliente.Id"
               class="btn ceibo-btn-primary rounded-pill mascotas-btn">
                + Nueva mascota
            </a>
        }
    </div>
</div>

@if (Model.Mascotas == null || !Model.Mascotas.Any())
{
    <div class="alert alert-info">
        Todavía no hay mascotas cargadas para este tutor.
        Usá el botón <strong>“Nueva mascota”</strong> para agregar la primera.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-active align-middle">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Especie</th>
                    <th>Raza</th>
                    <th>Edad</th>
                    <th>Castrado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in Model.Mascotas)
                {
                    <tr>
                        <td>@m.NombreMascota</td>
                        <td>@m.Especie</td>
                        <td>@m.Raza</td>
                        <td>
                            @{
                                var edad = m.EdadCalculada;
                            }
                            @if (edad.HasValue)
                            {
                                @($"{edad} años")
                            }
                            else
                            {
                                @("-")
                            }
                        </td>
                        <td>
                            @(m.Castrado ? "Sí" : "No")
                        </td>
                        <td class="text-end">

                            @* SOLO Admin + Veterinario pueden ver Consulta e Historia Clínica *@
                            @if (esAdmin || esVet)
                            {
                                <a asp-controller="ConsultasClinicas"
                                   asp-action="Index"
                                   asp-route-mascotaId="@m.Id"
                                   class="btn btn-sm btn-primary me-1">
                                    Consulta
                                </a>

                                <a asp-controller="PlanSanitario"
                                   asp-action="Index"
                                   asp-route-mascotaId="@m.Id"
                                   class="btn btn-sm btn-success me-1">
                                    Libreta sanitaria
                                </a>
                            }

                            @* Editar mascota *@
                            <a asp-action="Edit"
                               asp-route-id="@m.Id"
                               class="btn btn-sm btn-secondary me-1">
                                Editar
                            </a>

                            @* Eliminar con SweetAlert2 *@
                            <form asp-action="Delete"
                                  asp-route-id="@m.Id"
                                  method="post"
                                  class="d-inline delete-form">
                                @Html.AntiForgeryToken()
                                <button type="submit"
                                        class="btn btn-sm btn-danger">
                                    Eliminar
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="mt-3">
    <a asp-controller="Clientes"
       asp-action="Index"
       class="ceibo-back-pill">
        <span class="ceibo-back-pill-icon">←</span>
        Volver a clientes
    </a>
</div>

@section Scripts {
    <script>
        $(function () {
            $('.delete-form').on('submit', function (e) {
                e.preventDefault();

                var form = this;

                Swal.fire({
                    title: 'Eliminar mascota',
                    text: '¿Seguro que querés eliminar esta mascota? Esta acción no se puede deshacer.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then(function (result) {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });
    </script>
}

@model VeterinariaElCeibo.Models.Turno

@{
    ViewData["Title"] = "Editar turno";
}

<h1>Editar turno</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <form asp-action="Edit" method="post">
            @Html.AntiForgeryToken()

            <!-- Campos ocultos que no se editan -->
            <input type="hidden" asp-for="TurnoId" />
            <input type="hidden" asp-for="MascotaId" />
            <input type="hidden" asp-for="FechaCreacion" />

            <div asp-validation-summary="All" class="text-danger"></div>

            <!-- Mascota / Cliente solo lectura -->
            <div class="mb-3">
                <label class="form-label">Mascota</label>
                <input class="form-control" value="@Model.Mascota?.NombreMascota" disabled />
            </div>

            <div class="mb-3">
                <label class="form-label">Cliente</label>
                <input class="form-control" value="@Model.Mascota?.Cliente?.NombreCompleto" disabled />
            </div>

            <!-- Fecha y hora del turno (editable) -->
            <div class="mb-3">
                <label asp-for="FechaHora" class="form-label"></label>
                <input asp-for="FechaHora" class="form-control" type="datetime-local" id="FechaHora" />
                <span asp-validation-for="FechaHora" class="text-danger"></span>
            </div>

            <!-- Tipo de turno -->
            <div class="mb-3">
                <label asp-for="TipoTurno" class="form-label"></label>
                <select asp-for="TipoTurno" class="form-select">
                    <option value="Atención veterinaria">Atención veterinaria</option>
                    <option value="Peluquería">Peluquería</option>
                </select>
                <span asp-validation-for="TipoTurno" class="text-danger"></span>
            </div>

            <!-- Motivo -->
            <div class="mb-3">
                <label asp-for="Motivo" class="form-label"></label>
                <input asp-for="Motivo" class="form-control" />
                <span asp-validation-for="Motivo" class="text-danger"></span>
            </div>

            <!-- Estado del turno -->
            <div class="mb-3">
                <label asp-for="EstadoTurno" class="form-label"></label>
                <select asp-for="EstadoTurno" class="form-select">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Atendido">Atendido</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
                <span asp-validation-for="EstadoTurno" class="text-danger"></span>
            </div>

            <!-- Notas de recepción -->
            <div class="mb-3">
                <label asp-for="NotasRecepcion" class="form-label"></label>
                <textarea asp-for="NotasRecepcion" class="form-control" rows="3"></textarea>
                <span asp-validation-for="NotasRecepcion" class="text-danger"></span>
            </div>

            <div class="mt-4 d-flex justify-content-between">
                <a asp-action="Index"
                   class="ceibo-back-pill">
                    <span class="ceibo-back-pill-icon">←</span>
                    Volver a turnos del mes
                </a>

                <button type="submit" class="btn ceibo-btn-primary">
                    Guardar cambios
                </button>
            </div>
        </form>
    </div>

    <!-- Columna derecha: turnos del día (igual que en Create) -->
    <div class="col-md-6">
        <h4>Turnos ya agendados para ese día</h4>
        <p class="text-muted">
            Podés cambiar la fecha/hora del turno y ver qué otros turnos ya existen en ese día.
        </p>

        <!-- Fecha solo para CONSULTAR agenda -->
        <div class="mb-2">
            <label class="form-label" for="FechaConsulta">Fecha</label>
            <input type="date" id="FechaConsulta" class="form-control form-control-sm" />
        </div>

        <table class="table table-sm table-bordered" id="tablaTurnosDia" style="display:none;">
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Mascota</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div id="mensajeSinTurnos" class="text-muted" style="display:none;">
            No hay turnos para la fecha seleccionada.
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Función común para cargar los turnos de un día
        function cargarTurnosDia(valorFecha) {
            if (!valorFecha) {
                $('#tablaTurnosDia').hide();
                $('#mensajeSinTurnos').hide();
                return;
            }

            $.getJSON('@Url.Action("ObtenerTurnosPorFecha", "Turnos")',
                { fecha: valorFecha },
                function (data) {
                    var $tbody = $('#tablaTurnosDia tbody');
                    $tbody.empty();

                    if (!data || data.length === 0) {
                        $('#tablaTurnosDia').hide();
                        $('#mensajeSinTurnos').show();
                        return;
                    }

                    $('#mensajeSinTurnos').hide();
                    $('#tablaTurnosDia').show();

                    $.each(data, function (i, t) {
                        var fila = '<tr>' +
                            '<td>' + t.hora + '</td>' +
                            '<td>' + t.mascota + '</td>' +
                            '<td>' + t.cliente + '</td>' +
                            '<td>' + t.tipoTurno + '</td>' +
                            '<td>' + t.estado + '</td>' +
                            '</tr>';
                        $tbody.append(fila);
                    });
                });
        }

        $(document).ready(function () {

            // Al cargar la página, usamos la FechaHora del turno para mostrar agenda
            var valorInicial = $('#FechaHora').val(); // yyyy-MM-ddTHH:mm
            if (valorInicial) {
                var soloFecha = valorInicial.substring(0, 10); // yyyy-MM-dd
                $('#FechaConsulta').val(soloFecha);
                cargarTurnosDia(valorInicial);
            }

            // Cuando cambia la FECHA de consulta (solo día) -> carga agenda
            $('#FechaConsulta').change(function () {
                var valor = $(this).val();    // yyyy-MM-dd
                cargarTurnosDia(valor);
            });

            // Cuando cambia Fecha y hora del turno:
            // - sincronizamos la fecha en FechaConsulta
            // - cargamos agenda también
            $('#FechaHora').change(function () {
                var valor = $(this).val(); // yyyy-MM-ddTHH:mm
                if (valor) {
                    var soloFecha = valor.substring(0, 10); // yyyy-MM-dd
                    $('#FechaConsulta').val(soloFecha);
                }
                cargarTurnosDia(valor);
            });

        });
    </script>
}

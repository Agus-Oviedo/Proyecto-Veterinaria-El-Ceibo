@model IEnumerable<VeterinariaElCeibo.Models.ConsultaClinica>

@{
    ViewData["Title"] = "Historia clínica";

    var mascota = ViewBag.Mascota as VeterinariaElCeibo.Models.Mascota;
}

@if (mascota != null)
{
    <h1>Historia clínica</h1>
    <h5>
        Mascota: <strong>@mascota.NombreMascota</strong><br />
        Tutor: @mascota.Cliente?.NombreCompleto
    </h5>
}
else
{
    <h1>Historia clínica</h1>
}

<div class="mb-3">
    <a asp-action="Create"
       asp-route-mascotaId="@mascota?.Id"
       class="btn ceibo-btn-primary">
        + Nueva consulta
    </a>
</div>

<table class="table table-striped table-bordered">
    <thead class="table-light">
        <tr>
            <th>Fecha</th>
            <th>Motivo</th>
            <th>Veterinario</th>
            <th>Diagnóstico</th>
            <th style="width: 180px;">Acciones</th>
        </tr>
    </thead>
    <tbody>
        @if (!Model.Any())
        {
            <tr>
                <td colspan="5" class="text-center text-muted">
                    No hay consultas registradas para esta mascota.
                </td>
            </tr>
        }
        else
        {
            foreach (var c in Model)
            {
                <tr>
                    <td>@c.FechaConsulta.ToString("dd/MM/yyyy")</td>
                    <td>@c.Motivo</td>
                    <td>
                        @if (c.Veterinario != null)
                        {
                            @($"{c.Veterinario.Nombre} {c.Veterinario.Apellido}")
                        }
                        else
                        {
                            <span class="text-muted">–</span>
                        }
                    </td>
                    <td>
                        @if (!string.IsNullOrWhiteSpace(c.Diagnostico))
                        {
                            var texto = c.Diagnostico.Length > 50
                            ? c.Diagnostico.Substring(0, 50) + "..."
                            : c.Diagnostico;
                            @texto
                        }
                        else
                        {
                            <span class="text-muted">Sin diagnóstico registrado</span>
                        }
                    </td>
                    <td>
                        <a asp-action="Details"
                           asp-route-id="@c.Id"
                           class="btn btn-sm btn-primary me-1">
                            Ver
                        </a>

                        <a asp-action="Edit"
                           asp-route-id="@c.Id"
                           class="btn btn-sm btn-warning me-1">
                            Editar
                        </a>

                        <button type="button"
                                class="btn btn-sm btn-danger btn-eliminar-consulta"
                                data-id="@c.Id">
                            Eliminar
                        </button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<div class="mt-3">
    @if (mascota?.ClienteId != null)
    {
        <a asp-controller="Mascotas"
           asp-action="Index"
           asp-route-clienteId="@mascota.ClienteId"
           class="ceibo-back-pill">
            <span class="ceibo-back-pill-icon">←</span>
            Volver a mascotas
        </a>
    }
    else
    {
        <a asp-controller="Mascotas"
           asp-action="Index"
           class="ceibo-back-pill">
            <span class="ceibo-back-pill-icon">←</span>
            Volver a mascotas
        </a>
    }
</div>

@* Formulario oculto para eliminar (usado por SweetAlert) *@
<form id="formDeleteConsulta"
      asp-action="Delete"
      method="post"
      class="d-none">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="ConsultaDeleteId" />
</form>

@section Scripts {
    <script>
        $(function () {
            $('.btn-eliminar-consulta').on('click', function (e) {
                e.preventDefault();

                var id = $(this).data('id');

                Swal.fire({
                    title: '¿Eliminar consulta?',
                    text: 'Esta acción no se puede deshacer.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then(function (result) {
                    if (result.isConfirmed) {
                        $('#ConsultaDeleteId').val(id);
                        $('#formDeleteConsulta').submit();
                    }
                });
            });
        });
    </script>
}
